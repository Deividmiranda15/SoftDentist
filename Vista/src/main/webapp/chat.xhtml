<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>SoftDentist - Chat</title>
    <h:outputStylesheet name="css/patrondental.css" />

    <style type="text/css">

        /* Contenedor principal del layout */
        .chat-layout-container {
            display: flex; /* La clave para las columnas */
            min-height: 550px;
        }

        /* Columna izquierda (Contactos) */
        .chat-contacts {
            width: 300px; /* Ancho fijo */
            border-right: 1px solid #ddd;
            overflow-y: auto; /* Scroll si hay muchos contactos */
        }

        /* Columna derecha (Chat principal) */
        .chat-main {
            flex-grow: 1; /* Ocupa el resto del espacio */
            padding: 10px;
        }

        /* El resto de los estilos */
        .chat-history-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .chat-message {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .mensaje-mio {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .mensaje-suyo {
            background-color: #e9ecef;
            color: #333;
            margin-right: auto;
            text-align: left;
        }
        .chat-message .timestamp {
            font-size: 0.75em;
            color: #f1f1f1;
            display: block;
            margin-top: 4px;
        }
        .mensaje-suyo .timestamp {
            color: #777;
        }
        .contact-list ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .contact-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .contact-list li:hover {
            background-color: #f4f4f4;
        }
        .contact-list .ui-datalist-content {
            padding: 0 !important;
        }
        .chat-input-panel {
            padding: 10px !important;
            display: flex;
            border-top: 1px solid #ddd;
            margin-top: 10px;
        }
        .chat-input-text {
            flex-grow: 1;
            margin-right: 10px;
        }

    </style>
</h:head>

<h:body>

    <!-- Barra de navegación -->
    <header class="top-bar">
        <div class="logo">
            <h:graphicImage name="images/logo.png" style="height: 40px;"/>
        </div>
        <div class="user-info">
            <h:form>
                <p:commandButton value="Cerrar Sesión" styleClass="boton-barra"
                                 action="#{sessionBean.cerrarSesion}" />
            </h:form>
        </div>
    </header>

    <nav class="main-nav">
        <h:form>
            <!-- Botón de Inicio (Todos lo ven) -->
            <p:button value="Inicio" outcome="inicio_admin" icon="pi pi-home" styleClass="boton-barra"/>

            <!-- Botón de Citas (Todos lo ven) -->
            <p:button value="Citas" outcome="cita" icon="pi pi-calendar" styleClass="boton-barra"/>

            <!-- Botón de Chat (Todos lo ven) -->
            <p:button value="Chat" outcome="chat" icon="pi pi-comments" styleClass="boton-barra"/>

            <!--
              Botón de Pacientes (Solo el empleado y el admin lo ven)
            -->
            <p:button value="Pacientes" outcome="pacientes" icon="pi pi-users" styleClass="boton-barra"
                      rendered="#{sessionBean.esEmpleado or sessionBean.esAdmin}"/>

            <!--
              Botón de Empleados (Solo el admin lo ve)
            -->
            <p:button value="Empleados" outcome="empleados" icon="pi pi-id-card" styleClass="boton-barra"
                      rendered="#{sessionBean.esAdmin}"/>
        </h:form>
    </nav>

    <div class="contenedor-centrado">
        <h:form id="formChat">

            <h2 class="titulo-pagina">Centro de Mensajes</h2>

            <p:panel styleClass="panel-sombra" style="border: none;">
                <div class="chat-layout-container">

                    <!-- COLUMNA IZQUIERDA (Contactos) -->
                    <div class="chat-contacts contact-list">
                        <p:panel header="Contactos" style="border: none;">

                            <!--
                              Usamos sessionBean para decidir qué lista mostrar
                            -->
                            <p:dataList value="#{chatBean.listaPacientes}" var="pac" type="unordered"
                                        rendered="#{sessionBean.esEmpleado}"> <!-- (o Admin) -->
                                <li>
                                    <p:commandLink actionListener="#{chatBean.seleccionarContacto(pac.id, 'PACIENTE', pac.nombre.concat(' ').concat(pac.apellido))}"
                                                   update=":formChat:chatPanel"
                                                   style="display: block; text-decoration: none; color: #333;">
                                        <h:outputText value="#{pac.nombre} #{pac.apellido}" style="font-weight: bold;"/>
                                    </p:commandLink>
                                </li>
                            </p:dataList>

                            <p:dataList value="#{chatBean.listaEmpleados}" var="emp" type="unordered"
                                        rendered="#{sessionBean.esPaciente}">
                                <li>
                                    <p:commandLink actionListener="#{chatBean.seleccionarContacto(emp.id, 'EMPLEADO', emp.nombre.concat(' ').concat(emp.apellido))}"
                                                   update=":formChat:chatPanel"
                                                   style="display: block; text-decoration: none; color: #333;">
                                        <h:outputText value="Dr. #{emp.nombre} #{emp.apellido}" style="font-weight: bold;"/>
                                    </p:commandLink>
                                </li>
                            </p:dataList>
                        </p:panel>
                    </div>

                    <!-- Columna de Chat -->
                    <div class="chat-main">
                        <p:outputPanel id="chatPanel" style="width: 100%; height: 100%;">

                            <!-- Cabecera del chat -->
                            <p:panel header="Chat con: #{chatBean.contactoSeleccionadoNombre}"
                                     rendered="#{chatBean.contactoSeleccionadoId != null}"
                                     style="border: none;">

                                <div class="chat-history-container">
                                    <ui:repeat value="#{chatBean.chatHistory}" var="msg">
                                        <!--
                                          Usamos sessionBean para saber si el mensaje es 'mio'
                                        -->
                                        <div class="chat-message #{msg.idEmisor eq sessionBean.usuarioId ? 'mensaje-mio' : 'mensaje-suyo'}">
                                            <h:outputText value="#{msg.contenido}" />
                                            <span class="timestamp">
                                                <h:outputText value="#{msg.fechaEnvio}">
                                                    <f:convertDateTime pattern="dd/MM/yy HH:mm" type="both" />
                                                </h:outputText>
                                            </span>
                                        </div>
                                    </ui:repeat>
                                </div>

                                <!-- Panel de entrada de texto -->
                                <div class="chat-input-panel">
                                    <p:inputText value="#{chatBean.nuevoMensaje}"
                                                 placeholder="Escribe un mensaje..."
                                                 styleClass="chat-input-text ui-inputfield ui-widget ui-state-default ui-corner-all"
                                                 onkeypress="if (event.keyCode === 13) { pfbEnviar.click(); return false; }" />

                                    <p:commandButton value="Enviar"
                                                     actionListener="#{chatBean.enviarMensaje}"
                                                     update="chatPanel"
                                                     widgetVar="pfbEnviar"
                                                     styleClass="boton-barra" />
                                </div>

                            </p:panel>

                            <!-- Mensaje por defecto si no hay chat seleccionado -->
                            <p:panel header="Chat" rendered="#{chatBean.contactoSeleccionadoId == null}" style="border: none;">
                                <h:outputText value="Por favor, selecciona un contacto de la lista para iniciar una conversación." />
                            </p:panel>

                        </p:outputPanel>
                    </div>

                </div>
            </p:panel>
        </h:form>
    </div>
</h:body>
</html>