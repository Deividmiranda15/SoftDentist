<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

<h:head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mis Citas - SoftDentist</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&amp;display=swap" rel="stylesheet" />
    <h:outputStylesheet name="css/patrondental.css" />

    <style>
        .main-content-backdrop {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 80vh;
            padding-top: 40px;
        }

        .form-card {
            width: 85%;
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .form-card h2 {
            font-family: 'Poppins', sans-serif;
            color: #0e5c8e;
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 25px;
        }

        #formCitas\\:tablaCitas {
            width: 90% !important;
            margin: 0 auto;
            font-size: 16px;
        }

        .ui-datatable thead th {
            background-color: #0e5c8e !important;
            color: white !important;
            text-align: center;
            font-weight: 600;
        }

        .ui-datatable tbody td {
            text-align: center;
            padding: 12px 10px;
        }

        .ui-paginator {
            justify-content: center;
        }

        .ui-button-danger {
            font-size: 16px !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
        }

        .btn-pdf {
            background-color: #00796b !important;
            color: white !important;
            border: none !important;
            border-radius: 6px;
            padding: 6px 12px;
            font-weight: 600;
        }
    </style>
</h:head>

<h:body>
    <p:growl id="messages" showDetail="true" life="4000" />

    <header>
        <div class="top-bar">
            <h:graphicImage name="images/logo.png" alt="Logo Dental Patron" style="height: 60px;" />
        </div>
        <nav class="main-nav">
            <p:link outcome="inicio_paciente" value="INICIO" />
            <p:link outcome="cita" value="SOLICITAR CITA" />
            <p:link outcome="mis_citas" value="MIS CITAS" styleClass="active" />
        </nav>
    </header>

    <main class="main-content-backdrop">
        <div class="form-card">
            <h2>Mis Citas</h2>

            <h:form id="formCitas">
                <p:dataTable id="tablaCitas"
                             value="#{citaBean.citasRegistradas}"
                             var="c"
                             paginator="true" rows="5"
                             emptyMessage="No hay citas registradas.">

                    <p:column headerText="Fecha">
                        <h:outputText value="#{c.fecha}" />
                    </p:column>

                    <p:column headerText="Hora">
                        <h:outputText value="#{c.hora}" />
                    </p:column>

                    <p:column headerText="Motivo">
                        <h:outputText value="#{c.motivo}" />
                    </p:column>

                    <p:column headerText="Estado">
                        <h:outputText value="#{c.estado}" />
                    </p:column>

                    <p:column headerText="Receta">
                        <!-- SOLUCIÓN MÁS SIMPLE Y CONFIABLE -->
                        <h:outputLink value="/resources/recetas/receta_cita#{c.id}.pdf"
                                      target="_blank"
                                      rendered="#{c.estado eq 'Completada'}"
                                      styleClass="btn-pdf">
                            <i class="pi pi-file-pdf" style="margin-right:5px"></i>
                            Ver Receta
                        </h:outputLink>

                        <h:outputText value="No disponible"
                                      rendered="#{c.estado eq 'Completada'}"
                                      style="color: #999; font-style: italic;"/>

                        <h:outputText value="-"
                                      rendered="#{c.estado ne 'Completada'}"/>
                    </p:column>
                </p:dataTable>

                <div style="text-align:center; margin-top:25px;">
                    <p:commandButton value="Cancelar Cita"
                                     icon="pi pi-times"
                                     actionListener="#{citaBean.cancelarCita}"
                                     update=":formCitas :messages"
                                     process="@this"
                                     styleClass="ui-button-danger"
                                     style="width: 60%;">
                        <p:confirm header="Confirmar Cancelación"
                                   message="¿Está seguro de que desea cancelar esta cita?"
                                   icon="pi pi-exclamation-triangle" />
                    </p:commandButton>

                    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" severity="warn">
                        <p:commandButton value="Sí, cancelar" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
                        <p:commandButton value="No, mantener" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times" />
                    </p:confirmDialog>
                </div>
            </h:form>
        </div>
    </main>
</h:body>
</html>
